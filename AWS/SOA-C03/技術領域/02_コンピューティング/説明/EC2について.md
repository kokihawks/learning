# AWS EC2（Elastic Compute Cloud）について

## 概要

EC2（Elastic Compute Cloud）は、AWSのクラウド内でスケーラブルなコンピューティング容量を提供するサービスです。EC2を使用することで、仮想サーバー（インスタンス）を起動し、アプリケーションを実行できます。

## EC2の主な特徴

### 1. 柔軟性

#### インスタンスタイプの選択
- **多様なインスタンスタイプ**: 用途に応じて最適なインスタンスタイプを選択
- **インスタンスサイズ**: 小規模から大規模まで様々なサイズを提供
- **動的な変更**: インスタンスタイプを動的に変更可能（停止後）

---

### 2. スケーラビリティ

#### 自動スケーリング
- **Auto Scaling**: 需要に応じて自動的にスケーリング
- **Elastic Load Balancing**: トラフィックを複数のインスタンスに分散
- **オンデマンド**: 必要な時に必要な分だけ起動

---

### 3. 料金モデル

#### 料金オプション
- **オンデマンド**: 使用した分だけ支払う従量課金
- **Reserved Instances**: 1年または3年のコミットメントで割引
- **Saving Plans**: 使用量ベースのコミットメントで割引
- **Spot Instances**: 未使用容量を利用して最大90%の割引

---

## EC2インスタンスタイプ

### 1. 汎用インスタンス（M）

#### 特徴
- **バランス**: CPU、メモリ、ネットワークのバランスが取れている
- **用途**: Webサーバー、アプリケーションサーバー、開発環境など

#### インスタンスファミリー
- **M5/M5a/M5n**: 汎用インスタンス（最新世代）
- **M4**: 汎用インスタンス（前世代）

---

### 2. コンピューティング最適化インスタンス（C）

#### 特徴
- **高CPU**: CPUパフォーマンスが高い
- **用途**: バッチ処理、ゲームサーバー、科学計算など

#### インスタンスファミリー
- **C5/C5a/C5n**: コンピューティング最適化インスタンス（最新世代）
- **C4**: コンピューティング最適化インスタンス（前世代）

---

### 3. メモリ最適化インスタンス（R）

#### 特徴
- **高メモリ**: メモリ容量が大きい
- **用途**: データベース、メモリキャッシュ、ビッグデータ分析など

#### インスタンスファミリー
- **R5/R5a/R5n**: メモリ最適化インスタンス（最新世代）
- **R4**: メモリ最適化インスタンス（前世代）

---

### 4. ストレージ最適化インスタンス（I、D）

#### 特徴
- **高ストレージ**: ストレージ容量とIOPSが高い
- **用途**: データウェアハウス、NoSQLデータベース、ビッグデータ分析など

#### インスタンスファミリー
- **I3/I3en**: ストレージ最適化インスタンス
- **D2**: 高密度ストレージインスタンス

---

### 5. アクセラレーテッドコンピューティングインスタンス（P、G、F）

#### 特徴
- **GPU/FPGA**: GPUやFPGAを搭載
- **用途**: 機械学習、画像処理、動画エンコードなど

#### インスタンスファミリー
- **P3/P4**: GPUインスタンス
- **G4**: GPUインスタンス（グラフィックス最適化）
- **F1**: FPGAインスタンス

---

## EC2インスタンスの構成要素

### 1. AMI（Amazon Machine Image）

#### 概要
AMIは、EC2インスタンスを起動するために必要な情報を含むテンプレートです。

#### AMIの種類
- **AWS提供AMI**: AWSが提供するAMI（Amazon Linux、Ubuntu、Windowsなど）
- **コミュニティAMI**: コミュニティが提供するAMI
- **カスタムAMI**: 自分で作成したAMI

#### AMIの選択
- **OS**: オペレーティングシステムを選択
- **アーキテクチャ**: x86_64、ARM64など
- **リージョン**: リージョンごとにAMIが異なる

---

### 2. インスタンスストア

#### 概要
インスタンスストアは、EC2インスタンスに物理的に接続された一時的なストレージです。

#### 特徴
- **一時的**: インスタンスが停止または終了するとデータが失われる
- **高性能**: EBSボリュームよりも高いパフォーマンス
- **無料**: インスタンス料金に含まれる

#### 用途
- **一時的なデータ**: キャッシュ、一時ファイルなど
- **高パフォーマンス**: 高パフォーマンスが必要なワークロード

---

### 3. EBSボリューム

#### 概要
EBSボリュームは、EC2インスタンスに接続できる永続的なブロックストレージです。

#### 特徴
- **永続的**: インスタンスが停止してもデータが保持される
- **スナップショット**: スナップショットを作成してバックアップ可能
- **暗号化**: 暗号化を有効化可能

#### ボリュームタイプ
- **gp3/gp2**: 汎用SSD
- **io1/io2**: プロビジョンドIOPS SSD
- **st1**: スループット最適化HDD
- **sc1**: コールドHDD

---

### 4. セキュリティグループ

#### 概要
セキュリティグループは、EC2インスタンスへのトラフィックを制御する仮想ファイアウォールです。

#### 特徴
- **ステートフル**: インバウンドを許可すると、対応するアウトバウンドが自動的に許可される
- **インスタンスレベル**: インスタンスごとにセキュリティグループを設定
- **複数のセキュリティグループ**: 1つのインスタンスに複数のセキュリティグループを適用可能

---

### 5. Elastic IP

#### 概要
Elastic IPは、動的に割り当てられるパブリックIPアドレスです。

#### 特徴
- **静的IP**: インスタンスを停止・起動してもIPアドレスが変わらない
- **再割り当て**: 別のインスタンスに再割り当て可能
- **料金**: 使用していないElastic IPには料金が発生

---

### 6. インスタンスメタデータサービス（IMDS）

#### 概要
インスタンスメタデータサービス（IMDS）は、実行中のインスタンスからインスタンスに関する情報を取得できるサービスです。

#### 特徴
- **ローカルアクセスのみ**: インスタンス内からのみアクセス可能
- **HTTPエンドポイント**: `http://169.254.169.254/latest/meta-data/` でアクセス
- **バージョン**: IMDSv1とIMDSv2がある

#### IMDSv1 vs IMDSv2
- **IMDSv1**: シンプルなHTTPリクエストでアクセス可能
- **IMDSv2**: セッショントークンが必要で、よりセキュア

#### 取得可能な情報
- **インスタンスID**: インスタンスID
- **インスタンスタイプ**: インスタンスタイプ
- **AMI ID**: AMI ID
- **パブリックIP**: パブリックIPアドレス
- **IAMロール**: IAMロールの一時認証情報

---

### 7. ユーザーデータ（User Data）

#### 概要
ユーザーデータは、インスタンス起動時に実行されるスクリプトです。

#### 特徴
- **起動時実行**: インスタンス起動時に1回だけ実行
- **スクリプト形式**: シェルスクリプト、PowerShellスクリプトなど
- **Base64エンコード**: 最大16KB、Base64エンコードが必要

#### 使用例
- **ソフトウェアのインストール**: アプリケーションのインストール
- **設定の自動化**: 設定ファイルの作成
- **サービスの起動**: サービスの自動起動

---

### 8. プレースメントグループ（Placement Group）

#### 概要
プレースメントグループは、インスタンスの配置戦略を制御する機能です。

#### プレースメントグループの種類

##### クラスター配置グループ
- **低レイテンシ**: インスタンスを同じラックに配置して低レイテンシを実現
- **高スループット**: 高スループットが必要なワークロードに適している
- **単一AZ**: 単一の可用性ゾーン内に配置
- **制限**: 同じインスタンスタイプのみ使用可能

##### パーティション配置グループ
- **論理的分区**: インスタンスを論理的なパーティションに分離
- **障害分離**: パーティション間で障害が伝播しない
- **複数AZ**: 複数の可用性ゾーンに配置可能
- **用途**: HDFS、HBase、Cassandraなどの分散システム

##### 分散配置グループ
- **最大分散**: インスタンスを最大限に分散
- **障害分離**: インスタンス間で障害が伝播しない
- **複数AZ**: 複数の可用性ゾーンに配置可能
- **用途**: 高可用性が必要なワークロード

---

### 9. エンハンスドネットワーキング

#### 概要
エンハンスドネットワーキングは、ネットワークパフォーマンスを向上させる機能です。

#### エンハンスドネットワーキングの種類

##### SR-IOV（Single Root I/O Virtualization）
- **高パフォーマンス**: 高いネットワークパフォーマンス
- **低レイテンシ**: 低レイテンシ
- **サポート**: 特定のインスタンスタイプでサポート

##### ENA（Elastic Network Adapter）
- **高帯域幅**: 最大100Gbpsの帯域幅
- **広範囲のサポート**: 多くのインスタンスタイプでサポート
- **推奨**: 新規の使用ではENAが推奨

---

### 10. インスタンスの購入オプション

#### Dedicated Instances

##### 概要
Dedicated Instancesは、単一のAWSアカウント専用のハードウェアで実行されるインスタンスです。

##### 特徴
- **専用ハードウェア**: 単一のAWSアカウント専用のハードウェア
- **物理的分離**: 他のアカウントのインスタンスとは物理的に分離
- **コスト**: 通常のインスタンスよりも高額
- **コンプライアンス**: コンプライアンス要件に対応

---

#### Dedicated Hosts

##### 概要
Dedicated Hostsは、物理サーバー全体を専有できるサービスです。

##### 特徴
- **物理サーバー専有**: 物理サーバー全体を専有
- **ライセンス**: 既存のライセンスを使用可能
- **コスト**: 通常のインスタンスよりも高額
- **コンプライアンス**: コンプライアンス要件に対応

##### Dedicated Instances vs Dedicated Hosts

| 項目 | Dedicated Instances | Dedicated Hosts |
|------|---------------------|-----------------|
| **制御レベル** | インスタンスレベル | ホストレベル |
| **ライセンス** | AWSが管理 | 自分で管理 |
| **コスト** | 中程度 | 高額 |
| **柔軟性** | 高い | 低い |

---

### 11. 容量予約（Capacity Reservations）

#### 概要
容量予約は、特定の可用性ゾーンで容量を予約する機能です。

#### 特徴
- **容量保証**: 特定のAZで容量が保証される
- **料金**: オンデマンド料金（割引なし）
- **柔軟性**: インスタンスタイプ、OS、テナンシーを指定可能
- **期間**: 無期限または指定期間

#### 使用例
- **容量の保証**: 特定のAZで確実にインスタンスを起動する必要がある場合
- **コンプライアンス**: コンプライアンス要件で容量の保証が必要な場合

---

### 12. スナップショットとAMI

#### EBSスナップショット

##### 概要
EBSスナップショットは、EBSボリュームの特定時点のバックアップです。

##### 特徴
- **増分バックアップ**: 初回はフルバックアップ、以降は増分バックアップ
- **暗号化**: 暗号化されたボリュームのスナップショットも暗号化される
- **リージョン間コピー**: スナップショットを別のリージョンにコピー可能
- **共有**: 他のAWSアカウントとスナップショットを共有可能

##### スナップショットの作成
- **手動**: 手動でスナップショットを作成
- **自動**: 自動スナップショットを設定
- **ライフサイクルマネージャー**: Data Lifecycle Managerで自動管理

---

#### AMIの作成

##### 概要
AMIは、EBSスナップショットから作成できます。

##### AMIの作成方法
- **インスタンスから**: 実行中のインスタンスからAMIを作成
- **スナップショットから**: EBSスナップショットからAMIを作成
- **共有**: 他のAWSアカウントとAMIを共有可能

##### AMIの種類
- **EBS-backed AMI**: EBSボリュームを使用するAMI
- **Instance Store-backed AMI**: インスタンスストアを使用するAMI（非推奨）

---

### 13. インスタンスのモニタリング

#### 基本モニタリング

##### 概要
基本モニタリングは、5分間隔でメトリクスを収集します。

##### 特徴
- **無料**: 無料で利用可能
- **5分間隔**: 5分間隔でメトリクスを収集
- **標準メトリクス**: CPU、ネットワーク、ディスク、ステータスチェック

---

#### 詳細モニタリング

##### 概要
詳細モニタリングは、1分間隔でメトリクスを収集します。

##### 特徴
- **有料**: 追加料金が発生
- **1分間隔**: 1分間隔でメトリクスを収集
- **詳細なメトリクス**: より詳細なメトリクスを取得

---

#### CloudWatchエージェント

##### 概要
CloudWatchエージェントは、インスタンス内でメトリクスとログを収集するエージェントです。

##### 特徴
- **カスタムメトリクス**: カスタムメトリクスを収集
- **ログの収集**: ログファイルをCloudWatch Logsに送信
- **メモリとディスク**: メモリとディスクのメトリクスを収集

---

### 14. Systems Manager Session Manager

#### 概要
Systems Manager Session Managerは、SSHやRDPを使用せずにインスタンスに接続できるサービスです。

#### 特徴
- **SSH不要**: SSHキーやポートを開く必要がない
- **セキュア**: IAMでアクセスを制御
- **ログ記録**: セッションのログを記録
- **ポート不要**: ポート22や3389を開く必要がない

#### 前提条件
- **SSMエージェント**: SSMエージェントがインスタンスにインストールされている必要がある
- **IAMロール**: インスタンスに適切なIAMロールがアタッチされている必要がある
- **インターネットアクセス**: インターネットアクセスまたはVPCエンドポイントが必要

---

### 15. インスタンスのメンテナンス

#### スケジュールされたイベント

##### 概要
スケジュールされたイベントは、インスタンスのメンテナンスやリタイアメントに関する通知です。

##### イベントの種類
- **システム再起動**: システムの再起動が必要
- **システムメンテナンス**: システムのメンテナンスが必要
- **インスタンス再起動**: インスタンスの再起動が必要
- **インスタンスリタイアメント**: インスタンスのリタイアメント

##### イベントの通知
- **インスタンスメタデータ**: インスタンスメタデータからイベントを確認
- **EventBridge**: EventBridgeでイベントを監視
- **CloudWatch Events**: CloudWatch Eventsでイベントを監視

---

### 16. スポットインスタンスの詳細

#### スポットフリート（Spot Fleet）

##### 概要
スポットフリートは、複数のインスタンスタイプやAZを組み合わせて、スポットインスタンスとオンデマンドインスタンスを混在させることができます。

##### 特徴
- **複数のインスタンスタイプ**: 複数のインスタンスタイプを指定可能
- **混在**: スポットインスタンスとオンデマンドインスタンスを混在可能
- **自動スケーリング**: ターゲットキャパシティに基づいて自動スケーリング
- **コスト削減**: コストを削減しながら可用性を確保

##### 割り当て戦略
- **lowestPrice**: 最低価格のインスタンスを選択
- **diversified**: 複数のインスタンスタイプに分散
- **capacityOptimized**: 容量が最適化されたインスタンスを選択

---

#### スポットブロック（非推奨）

##### 概要
スポットブロックは、1-6時間の期間でスポットインスタンスを予約する機能です（現在は非推奨）。

##### 非推奨の理由
- **Saving Plans**: Saving Plansが推奨される
- **柔軟性**: Saving Plansの方が柔軟性が高い

---

### 17. インスタンスのライフサイクルフック

#### 概要
ライフサイクルフックは、Auto Scalingグループのインスタンスのライフサイクルイベントに介入する機能です。

#### ライフサイクルフックの種類
- **launching**: インスタンス起動時
- **terminating**: インスタンス終了時

#### 使用例
- **アプリケーションの準備**: インスタンス起動時にアプリケーションの準備を完了
- **グレースフルシャットダウン**: インスタンス終了時にグレースフルシャットダウンを実行

---

### 18. インスタンスストア vs EBSの比較

| 項目 | インスタンスストア | EBSボリューム |
|------|-------------------|--------------|
| **永続性** | 一時的（インスタンス停止/終了で削除） | 永続的（インスタンス停止後も保持） |
| **パフォーマンス** | 高い | 中程度 |
| **料金** | インスタンス料金に含まれる | 別途料金 |
| **スナップショット** | 不可 | 可能 |
| **暗号化** | 不可 | 可能 |
| **サイズ** | インスタンスタイプに依存 | 1GBから16TBまで |

---

### 19. インスタンスの起動テンプレート

#### 概要
起動テンプレートは、インスタンスの起動設定を定義するテンプレートです。

#### 起動テンプレートの要素
- **AMI**: 使用するAMI
- **インスタンスタイプ**: インスタンスタイプ
- **セキュリティグループ**: セキュリティグループ
- **IAMロール**: IAMロール
- **ユーザーデータ**: ユーザーデータ
- **タグ**: タグ

#### 起動テンプレートの利点
- **再利用性**: テンプレートを再利用可能
- **バージョン管理**: 複数のバージョンを管理可能
- **Auto Scaling**: Auto Scalingグループで使用可能

---

### 20. インスタンスの購入オプションの比較

| 購入オプション | 割引率 | 柔軟性 | 中断リスク | 適用シーン |
|--------------|--------|--------|-----------|-----------|
| **オンデマンド** | 0% | 最高 | なし | 短期・予測不可能なワークロード |
| **Reserved Instances** | 最大75% | 低い | なし | 安定した長期ワークロード |
| **Saving Plans** | 最大72% | 高い | なし | 柔軟性が必要な長期ワークロード |
| **Spot Instances** | 最大90% | 中 | あり | 中断可能なワークロード |
| **Dedicated Instances** | 0% | 中 | なし | コンプライアンス要件がある場合 |
| **Dedicated Hosts** | 0% | 低い | なし | ライセンス要件がある場合 |

---

## EC2インスタンスのライフサイクル

### 1. インスタンスの状態

#### 起動中（Pending）
- **状態**: インスタンスが起動している
- **アクション**: インスタンスの準備が完了するまで待機

#### 実行中（Running）
- **状態**: インスタンスが実行中
- **アクション**: アプリケーションを実行可能

#### 停止中（Stopping）
- **状態**: インスタンスが停止している
- **アクション**: インスタンスの停止処理中

#### 停止済み（Stopped）
- **状態**: インスタンスが停止済み
- **アクション**: インスタンスを再起動可能

#### 終了中（Terminating）
- **状態**: インスタンスが終了している
- **アクション**: インスタンスの終了処理中

#### 終了済み（Terminated）
- **状態**: インスタンスが終了済み
- **アクション**: インスタンスは削除される

---

### 2. インスタンスの停止と終了

#### 停止（Stop）
- **データ保持**: EBSボリュームのデータは保持される
- **再起動可能**: インスタンスを再起動可能
- **料金**: インスタンス料金は発生しない（EBSボリューム料金は発生）

#### 終了（Terminate）
- **データ削除**: インスタンスストアのデータは削除される
- **EBSボリューム**: デフォルトでEBSボリュームも削除される（設定可能）
- **再起動不可**: インスタンスは再起動不可

---

## EC2のベストプラクティス

### 1. インスタンスタイプの選択

#### 推奨事項
- **ワークロード**: ワークロードの特性に応じてインスタンスタイプを選択
- **Right Sizing**: 適切なサイズのインスタンスを選択
- **コスト最適化**: コストとパフォーマンスのバランスを考慮

---

### 2. 高可用性の設計

#### 推奨事項
- **複数のAZ**: 複数の可用性ゾーンにインスタンスを配置
- **Auto Scaling**: Auto Scalingを使用して自動的にスケーリング
- **Elastic Load Balancing**: ELBを使用してトラフィックを分散

---

### 3. セキュリティの設定

#### 推奨事項
- **セキュリティグループ**: 必要最小限のアクセス権限を設定
- **IAMロール**: IAMロールを使用してインスタンスに権限を付与
- **暗号化**: EBSボリュームを暗号化

---

### 4. コスト最適化

#### 推奨事項
- **Reserved Instances**: 長期運用にはReserved Instancesを検討
- **Saving Plans**: 柔軟性が必要な場合はSaving Plansを検討
- **Spot Instances**: 中断可能なワークロードにはSpot Instancesを検討
- **未使用インスタンス**: 未使用のインスタンスを停止または終了

---

## 参考資料

- [AWS EC2公式ドキュメント](https://docs.aws.amazon.com/ec2/)
- [AWS EC2インスタンスタイプ](https://aws.amazon.com/ec2/instance-types/)
- [AWS EC2ベストプラクティス](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-best-practices.html)

