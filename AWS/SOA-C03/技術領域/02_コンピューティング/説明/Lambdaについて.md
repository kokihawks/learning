# AWS Lambdaについて

## 概要

Lambdaは、サーバーを管理することなくコードを実行できるサーバーレスコンピューティングサービスです。Lambdaを使用することで、イベントに応じてコードを実行し、必要な分だけ課金されます。

## Lambdaの主な特徴

### 1. サーバーレス

#### サーバー管理不要
- **インフラ管理不要**: サーバーのプロビジョニング、管理、メンテナンスが不要
- **自動スケーリング**: 需要に応じて自動的にスケーリング
- **高可用性**: 自動的に高可用性が確保

---

### 2. イベント駆動

#### イベントソース
- **多様なイベントソース**: S3、DynamoDB、API Gateway、SNS、SQSなど
- **自動実行**: イベントが発生すると自動的にLambda関数が実行される
- **非同期実行**: 非同期で実行可能

---

### 3. 従量課金

#### 料金体系
- **リクエスト数**: リクエストごとに課金
- **実行時間**: 実行時間に応じて課金
- **無料枠**: 毎月100万リクエストと40万GB秒の無料枠

---

## Lambda関数の構成要素

### 1. 関数コード

#### サポートされている言語
- **Node.js**: JavaScript、TypeScript
- **Python**: Python 3.x
- **Java**: Java 8、11、17
- **C#**: .NET Core
- **Go**: Go 1.x
- **Ruby**: Ruby 2.7
- **カスタムランタイム**: カスタムランタイムを作成可能

#### コードのデプロイ
- **ZIPファイル**: ZIPファイルとしてアップロード
- **コンテナイメージ**: コンテナイメージとしてデプロイ
- **インライン編集**: コンソールで直接編集（小規模なコード）

---

### 2. ランタイム設定

#### メモリ設定
- **メモリ範囲**: 128MBから10GBまで設定可能
- **CPU割り当て**: メモリに比例してCPUが割り当てられる
- **料金**: メモリと実行時間に基づいて課金

#### タイムアウト設定
- **タイムアウト**: 最大15分（900秒）
- **デフォルト**: 3秒
- **推奨**: ワークロードに応じて適切に設定

---

### 3. 環境変数

#### 環境変数の設定
- **キーと値**: キーと値のペアで設定
- **暗号化**: AWS KMSを使用して暗号化可能
- **バージョン管理**: バージョンごとに異なる環境変数を設定可能

---

### 4. IAMロール

#### 実行ロール
- **権限**: Lambda関数がAWSサービスにアクセスするための権限
- **最小権限**: 必要最小限の権限を付与
- **信頼ポリシー**: Lambdaサービスがロールを引き受けるための信頼ポリシー

---

## Lambda関数のバージョンとエイリアス

### 1. バージョン

#### 概要
バージョンは、Lambda関数の不変のスナップショットです。

#### 特徴
- **不変**: バージョンは変更不可
- **ARN**: 各バージョンに固有のARNが割り当てられる
- **$LATEST**: 最新のコードを指す特殊なバージョン

#### バージョンの発行
- **手動発行**: 手動でバージョンを発行
- **自動発行**: デプロイ時に自動的にバージョンを発行（オプション）

---

### 2. エイリアス

#### 概要
エイリアスは、Lambda関数のバージョンへのポインタです。

#### 特徴
- **可変**: エイリアスは異なるバージョンを指すように変更可能
- **重み付きエイリアス**: 複数のバージョンに重みを付けてトラフィックを分散可能
- **Blue/Greenデプロイ**: Blue/Greenデプロイメントを実現

#### エイリアスの使用例
- **本番環境**: 本番環境用のエイリアス
- **ステージング環境**: ステージング環境用のエイリアス
- **カナリアリリース**: カナリアリリース用のエイリアス

---

## Lambda関数のイベントソース

### 1. 同期実行

#### イベントソース
- **API Gateway**: HTTP/HTTPSリクエスト
- **Application Load Balancer**: ALBからのリクエスト
- **CloudFront**: CloudFrontからのリクエスト
- **Cognito**: Cognitoからのリクエスト

#### 特徴
- **即座に応答**: リクエストに対して即座に応答
- **エラーハンドリング**: エラーが発生した場合、呼び出し元にエラーが返される

---

### 2. 非同期実行

#### イベントソース
- **S3**: S3イベント（オブジェクトの作成、削除など）
- **DynamoDB**: DynamoDBストリーム
- **SNS**: SNSトピック
- **EventBridge**: EventBridgeイベント
- **SQS**: SQSキュー

#### 特徴
- **非同期**: イベントが発生すると非同期で実行
- **リトライ**: エラーが発生した場合、自動的にリトライ
- **デッドレターキュー**: リトライに失敗した場合、DLQに送信可能

---

## Lambda関数の同時実行

### 1. 同時実行数の制限

#### デフォルト制限
- **リージョンごと**: リージョンごとに1,000同時実行（デフォルト）
- **アカウントごと**: アカウントごとに制限がある
- **増加可能**: サポートに依頼して制限を増加可能

---

### 2. 同時実行数の管理

#### 予約済み同時実行
- **予約**: 特定の関数のために同時実行数を予約
- **保証**: 予約した同時実行数が保証される
- **料金**: 予約済み同時実行には追加料金が発生

#### プロビジョンド同時実行
- **即座にスケーリング**: 即座にスケーリング可能
- **コールドスタート削減**: コールドスタートを削減
- **料金**: プロビジョンド同時実行には追加料金が発生

---

## Lambda関数のVPC統合

### 1. VPC統合の概要

#### 概要
Lambda関数をVPC内のリソース（RDS、ElastiCacheなど）にアクセスさせるために、VPC統合を使用します。

#### 特徴
- **ENI**: Lambda関数がVPC内にENI（Elastic Network Interface）を作成
- **セキュリティグループ**: セキュリティグループでトラフィックを制御
- **サブネット**: サブネットを選択してENIを配置

---

### 2. VPC統合の注意事項

#### コールドスタート
- **遅延**: VPC統合を使用すると、コールドスタートの時間が長くなる
- **ENIの作成**: ENIの作成に時間がかかる
- **推奨**: プロビジョンド同時実行を使用してコールドスタートを削減

#### インターネットアクセス
- **NATゲートウェイ**: VPC統合を使用すると、インターネットアクセスにはNATゲートウェイが必要
- **VPCエンドポイント**: VPCエンドポイントを使用してインターネットアクセスを回避

---

## Lambda関数のベストプラクティス

### 1. 関数の設計

#### 推奨事項
- **単一責任**: 1つの関数は1つの責任を持つ
- **ステートレス**: 関数はステートレスに設計
- **軽量**: 関数は軽量に保つ

---

### 2. パフォーマンスの最適化

#### 推奨事項
- **コールドスタート削減**: プロビジョンド同時実行を使用
- **メモリ最適化**: 適切なメモリ設定を選択
- **接続の再利用**: データベース接続などを再利用

---

### 3. エラーハンドリング

#### 推奨事項
- **リトライ**: 一時的なエラーに対してリトライを実装
- **デッドレターキュー**: DLQを使用して失敗したイベントを処理
- **ロギング**: CloudWatch Logsを使用してログを記録

---

### 4. セキュリティの設定

#### 推奨事項
- **IAMロール**: 最小権限の原則に従ってIAMロールを設定
- **環境変数の暗号化**: 機密情報は環境変数で暗号化
- **VPC統合**: 必要に応じてVPC統合を使用

---

## 参考資料

- [AWS Lambda公式ドキュメント](https://docs.aws.amazon.com/lambda/)
- [AWS Lambdaベストプラクティス](https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html)
- [AWS Lambda料金](https://aws.amazon.com/lambda/pricing/)

