# AWS セキュリティグループとネットワークACLについて

## 概要

セキュリティグループとネットワークACLは、VPC内のネットワークトラフィックを制御するセキュリティ機能です。セキュリティグループはインスタンスレベルのセキュリティを提供し、ネットワークACLはサブネットレベルのセキュリティを提供します。

## セキュリティグループ（Security Groups）

### 1. セキュリティグループの概要

#### 概要
セキュリティグループは、EC2インスタンスやその他のAWSリソースへのトラフィックを制御する仮想ファイアウォールです。

#### 特徴
- **ステートフル**: インバウンドルールを許可すると、アウトバウンドトラフィックが自動的に許可される
- **インスタンスレベル**: インスタンスごとにセキュリティグループを設定
- **デフォルト拒否**: 明示的に許可しない限り、すべてのトラフィックが拒否される
- **複数のセキュリティグループ**: 1つのインスタンスに複数のセキュリティグループを適用可能

---

### 2. セキュリティグループのルール

#### インバウンドルール（Inbound Rules）
- **ソース**: トラフィックの送信元（IPアドレス、CIDRブロック、セキュリティグループ）
- **プロトコル**: TCP、UDP、ICMP、すべて
- **ポート範囲**: ポート番号またはポート範囲
- **説明**: ルールの説明（オプション）

#### アウトバウンドルール（Outbound Rules）
- **送信先**: トラフィックの送信先（IPアドレス、CIDRブロック、セキュリティグループ）
- **プロトコル**: TCP、UDP、ICMP、すべて
- **ポート範囲**: ポート番号またはポート範囲
- **説明**: ルールの説明（オプション）

---

### 3. セキュリティグループの動作

#### ステートフルな動作
- **インバウンド許可**: インバウンドトラフィックを許可すると、対応するアウトバウンドトラフィックが自動的に許可される
- **アウトバウンド許可**: アウトバウンドトラフィックを許可しても、対応するインバウンドトラフィックは自動的に許可されない

#### 例
- **HTTPリクエスト**: インバウンドでポート80を許可すると、アウトバウンドのHTTPレスポンスが自動的に許可される
- **HTTPSリクエスト**: インバウンドでポート443を許可すると、アウトバウンドのHTTPSレスポンスが自動的に許可される

---

### 4. セキュリティグループの参照

#### セキュリティグループをソースとして使用
- **同じセキュリティグループ**: 同じセキュリティグループ内のインスタンス間の通信を許可
- **別のセキュリティグループ**: 別のセキュリティグループをソースとして指定可能
- **柔軟性**: セキュリティグループを変更すると、関連するすべてのルールが自動的に更新される

#### 例
- **Webサーバー**: セキュリティグループA（ポート80、443を許可）
- **アプリケーションサーバー**: セキュリティグループB（セキュリティグループAをソースとして許可）
- **データベースサーバー**: セキュリティグループC（セキュリティグループBをソースとして許可）

---

### 5. セキュリティグループの制限事項

#### 制限
- **ルール数**: セキュリティグループごとに最大60個のインバウンドルール、60個のアウトバウンドルール
- **セキュリティグループ数**: インスタンスごとに最大5つのセキュリティグループ
- **VPCごと**: VPCごとに最大2,500個のセキュリティグループ

---

## ネットワークACL（Network ACL）

### 1. ネットワークACLの概要

#### 概要
ネットワークACLは、サブネットレベルでネットワークトラフィックを制御するオプションのセキュリティレイヤーです。

#### 特徴
- **ステートレス**: インバウンドとアウトバウンドのルールを個別に設定する必要がある
- **サブネットレベル**: サブネットごとにネットワークACLを設定
- **デフォルト許可**: 明示的に拒否しない限り、すべてのトラフィックが許可される
- **ルール番号**: ルール番号の順序で評価される

---

### 2. ネットワークACLのルール

#### インバウンドルール（Inbound Rules）
- **ルール番号**: 1-32766（小さい番号から評価）
- **タイプ**: カスタムTCP、カスタムUDP、すべてのTCP、すべてのUDP、すべてのICMP、すべてのトラフィック
- **プロトコル**: TCP、UDP、ICMP、すべて
- **ポート範囲**: ポート番号またはポート範囲
- **ソース**: IPアドレスまたはCIDRブロック
- **許可/拒否**: トラフィックを許可または拒否

#### アウトバウンドルール（Outbound Rules）
- **ルール番号**: 1-32766（小さい番号から評価）
- **タイプ**: カスタムTCP、カスタムUDP、すべてのTCP、すべてのUDP、すべてのICMP、すべてのトラフィック
- **プロトコル**: TCP、UDP、ICMP、すべて
- **ポート範囲**: ポート番号またはポート範囲
- **送信先**: IPアドレスまたはCIDRブロック
- **許可/拒否**: トラフィックを許可または拒否

---

### 3. ネットワークACLの動作

#### ステートレスな動作
- **インバウンドとアウトバウンド**: インバウンドとアウトバウンドのルールを個別に設定する必要がある
- **ルール番号の順序**: ルール番号の小さい順に評価され、最初に一致したルールが適用される
- **デフォルトルール**: すべてのトラフィックを許可するデフォルトルールが最後に評価される

#### 例
- **HTTPリクエスト**: インバウンドでポート80を許可し、アウトバウンドでポート80を許可する必要がある
- **HTTPSリクエスト**: インバウンドでポート443を許可し、アウトバウンドでポート443を許可する必要がある

---

### 4. ネットワークACLのデフォルトルール

#### デフォルトネットワークACL
- **すべてのトラフィックを許可**: デフォルトですべてのインバウンドとアウトバウンドトラフィックを許可
- **カスタマイズ可能**: カスタムルールを追加してトラフィックを制御可能

#### カスタムネットワークACL
- **すべてのトラフィックを拒否**: デフォルトですべてのインバウンドとアウトバウンドトラフィックを拒否
- **明示的な許可**: 必要なトラフィックを明示的に許可する必要がある

---

### 5. ネットワークACLの制限事項

#### 制限
- **ルール数**: ネットワークACLごとに最大20個のインバウンドルール、20個のアウトバウンドルール
- **VPCごと**: VPCごとに最大200個のネットワークACL

---

## セキュリティグループ vs ネットワークACL

### 1. 主な違い

| 項目 | セキュリティグループ | ネットワークACL |
|------|---------------------|-----------------|
| **レベル** | インスタンスレベル | サブネットレベル |
| **動作** | ステートフル | ステートレス |
| **デフォルト** | すべて拒否 | すべて許可（デフォルトACL） |
| **ルール評価** | すべてのルールを評価 | ルール番号の順序で評価 |
| **ソース/送信先** | IPアドレス、CIDRブロック、セキュリティグループ | IPアドレス、CIDRブロックのみ |
| **ルール数** | 最大60個（インバウンド/アウトバウンド） | 最大20個（インバウンド/アウトバウンド） |

---

### 2. 使用の推奨

#### セキュリティグループを使用すべき場合
- **インスタンスレベルのセキュリティ**: インスタンスごとに異なるセキュリティ設定が必要
- **柔軟性**: セキュリティグループを参照して柔軟に設定
- **一般的な使用**: ほとんどの場合、セキュリティグループで十分

#### ネットワークACLを使用すべき場合
- **サブネットレベルのセキュリティ**: サブネット全体にセキュリティルールを適用
- **追加のセキュリティレイヤー**: セキュリティグループに加えて追加のセキュリティレイヤーが必要
- **コンプライアンス**: コンプライアンス要件でサブネットレベルのセキュリティが必要

---

## ベストプラクティス

### 1. セキュリティグループのベストプラクティス

#### 最小権限の原則
- **必要最小限のアクセス**: 必要最小限のポートとプロトコルのみを許可
- **特定のソース**: 特定のIPアドレスまたはセキュリティグループからのアクセスのみを許可
- **定期的な見直し**: 定期的にセキュリティグループルールを見直し

#### セキュリティグループの設計
- **用途別**: 用途別にセキュリティグループを作成（Web、アプリケーション、データベース）
- **環境別**: 環境別にセキュリティグループを作成（本番、ステージング、開発）
- **命名規則**: 明確な命名規則を使用

---

### 2. ネットワークACLのベストプラクティス

#### ネットワークACLの設計
- **サブネット別**: サブネット別にネットワークACLを作成
- **ルール番号**: ルール番号を適切に設定（例：100、200、300など）
- **明示的な拒否**: 不要なトラフィックを明示的に拒否

#### ネットワークACLの使用
- **追加のセキュリティレイヤー**: セキュリティグループに加えて追加のセキュリティレイヤーとして使用
- **コンプライアンス**: コンプライアンス要件でサブネットレベルのセキュリティが必要な場合に使用

---

## 参考資料

- [AWS セキュリティグループ公式ドキュメント](https://docs.aws.amazon.com/vpc/latest/userguide/security-groups.html)
- [AWS ネットワークACL公式ドキュメント](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html)
- [AWS VPCセキュリティベストプラクティス](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-best-practices.html)

