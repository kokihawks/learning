# AWS VPC（Virtual Private Cloud）について

## 概要

VPC（Virtual Private Cloud）は、AWSクラウド内に論理的に分離された仮想ネットワークです。VPCを使用することで、独自のIPアドレス範囲の選択、サブネットの作成、ルートテーブルとネットワークゲートウェイの設定、セキュリティ設定の管理が可能になります。

## VPCの主な特徴

### 1. 論理的な分離
- **独立したネットワーク**: 他のAWSアカウントやVPCから論理的に分離
- **カスタムIPアドレス範囲**: 独自のIPアドレス範囲（CIDRブロック）を設定
- **完全な制御**: ネットワーク設定を完全に制御可能

### 2. 柔軟性
- **複数のVPC**: 複数のVPCを作成可能
- **リージョンごとのVPC**: リージョンごとに独立したVPC
- **カスタマイズ可能**: ニーズに応じてカスタマイズ可能

### 3. セキュリティ
- **セキュリティグループ**: インスタンスレベルのセキュリティ
- **ネットワークACL**: サブネットレベルのセキュリティ
- **プライベートサブネット**: インターネットに直接アクセスできないサブネット

---

## VPCの構成要素

### 1. CIDRブロック

#### 概要
VPCには、プライマリCIDRブロックを割り当てる必要があります。CIDRブロックは、VPC内で使用可能なIPアドレス範囲を定義します。

#### 主なCIDRブロック
- **10.0.0.0/16**: 10.0.0.0から10.0.255.255まで（65,536個のIPアドレス）
- **172.16.0.0/12**: 172.16.0.0から172.31.255.255まで（1,048,576個のIPアドレス）
- **192.168.0.0/16**: 192.168.0.0から192.168.255.255まで（65,536個のIPアドレス）

#### 注意事項
- RFC 1918のプライベートIPアドレス範囲を使用することを推奨
- オンプレミスネットワークと重複しないIPアドレス範囲を選択
- 将来の拡張を考慮して十分なIPアドレス範囲を確保

---

### 2. サブネット（Subnet）

#### 概要
サブネットは、VPC内のIPアドレス範囲です。サブネットを使用して、VPCを複数の論理的なネットワークに分割できます。

#### サブネットの種類

##### パブリックサブネット
- **インターネットゲートウェイ**: インターネットゲートウェイにルーティングされるサブネット
- **パブリックIP**: パブリックIPアドレスを割り当て可能
- **用途**: Webサーバー、ロードバランサーなど

##### プライベートサブネット
- **インターネットアクセスなし**: インターネットに直接アクセスできないサブネット
- **NATゲートウェイ**: NATゲートウェイ経由でインターネットにアクセス可能
- **用途**: データベースサーバー、アプリケーションサーバーなど

#### サブネットの設計
- **可用性ゾーン（AZ）**: 各サブネットは1つのAZに配置
- **複数のAZ**: 高可用性のために複数のAZにサブネットを配置
- **IPアドレス範囲**: サブネットごとにIPアドレス範囲を設定

---

### 3. ルートテーブル（Route Table）

#### 概要
ルートテーブルは、ネットワークトラフィックのルーティングを制御します。各サブネットには、1つのルートテーブルを関連付ける必要があります。

#### ルートテーブルの種類

##### メインルートテーブル
- **デフォルトルートテーブル**: VPC作成時に自動的に作成
- **すべてのサブネット**: 明示的に関連付けられていないサブネットは、メインルートテーブルを使用

##### カスタムルートテーブル
- **カスタムルーティング**: カスタムルーティングルールを設定
- **サブネットごと**: サブネットごとに異なるルートテーブルを設定可能

#### ルートテーブルのルール
- **ローカルルート**: VPC内の通信（自動的に追加）
- **インターネットゲートウェイ**: インターネットへのルーティング
- **NATゲートウェイ**: NATゲートウェイへのルーティング
- **VPCピアリング**: VPCピアリング接続へのルーティング
- **Transit Gateway**: Transit Gatewayへのルーティング

---

### 4. インターネットゲートウェイ（IGW）

#### 概要
インターネットゲートウェイは、VPCとインターネット間の通信を可能にするゲートウェイです。

#### 特徴
- **水平スケーラブル**: 自動的にスケーリング
- **高可用性**: 高可用性が保証
- **管理不要**: AWSが管理
- **コスト**: 使用量に応じた課金なし（データ転送料金のみ）

#### 設定
- **VPCへのアタッチ**: VPCにアタッチする必要がある
- **ルートテーブル**: ルートテーブルにルートを追加
- **パブリックIP**: パブリックサブネットのインスタンスにパブリックIPを割り当て

---

### 5. NATゲートウェイ

#### 概要
NATゲートウェイは、プライベートサブネットのインスタンスがインターネットにアクセスできるようにするゲートウェイです。

#### 特徴
- **マネージドサービス**: AWSが管理するマネージドサービス
- **高可用性**: 単一のAZに配置（複数のAZに配置して高可用性を確保）
- **自動スケーリング**: 自動的にスケーリング
- **コスト**: 時間単位の料金とデータ転送料金

#### NATゲートウェイの種類

##### パブリックNATゲートウェイ
- **パブリックサブネット**: パブリックサブネットに配置
- **Elastic IP**: Elastic IPアドレスが必要
- **用途**: プライベートサブネットからインターネットへのアウトバウンド通信

##### プライベートNATゲートウェイ
- **プライベートサブネット**: プライベートサブネットに配置
- **用途**: VPCピアリングやTransit Gateway経由の通信

#### NATゲートウェイ vs NATインスタンス

| 項目 | NATゲートウェイ | NATインスタンス |
|------|----------------|----------------|
| **管理** | マネージドサービス | 自己管理 |
| **可用性** | 単一AZ（複数AZで高可用性） | 単一インスタンス |
| **スケーラビリティ** | 自動スケーリング | 手動スケーリング |
| **メンテナンス** | 不要 | 必要 |
| **コスト** | 時間単位の料金 | EC2インスタンス料金 |

---

### 6. VPCピアリング

#### 概要
VPCピアリングは、2つのVPC間でプライベートIPアドレスを使用して通信を可能にする接続です。

#### 特徴
- **プライベート通信**: プライベートIPアドレスを使用
- **非推移的**: VPC AとVPC Bがピアリング、VPC BとVPC Cがピアリングしても、VPC AとVPC Cは直接通信できない
- **リージョン間**: 異なるリージョン間でもピアリング可能
- **CIDRブロック**: ピアリングするVPCのCIDRブロックが重複してはいけない

#### VPCピアリングの設定
- **リクエスター**: ピアリング接続をリクエストするVPC
- **アクセプター**: ピアリング接続を受け入れるVPC
- **ルートテーブル**: 両方のVPCのルートテーブルにルートを追加
- **セキュリティグループ**: セキュリティグループでトラフィックを許可

---

### 7. Transit Gateway

#### 概要
Transit Gatewayは、複数のVPC、VPN、Direct Connect接続を中央で管理するネットワークハブです。

#### 特徴
- **中央管理**: 複数のネットワーク接続を中央で管理
- **スケーラビリティ**: 数千のVPCを接続可能
- **ルーティング**: ルーティングテーブルでトラフィックを制御
- **コスト**: 時間単位の料金とデータ転送料金

#### Transit Gatewayの利点
- **複雑さの削減**: 複数のVPCピアリング接続を削減
- **管理の簡素化**: 中央でネットワークを管理
- **コスト削減**: VPCピアリング接続の数を削減
- **柔軟性**: 動的にVPCを追加・削除可能

---

## VPCの設計パターン

### 1. シンプルなVPC設計

#### 構成
- **1つのVPC**: 1つのVPCにすべてのリソースを配置
- **パブリックサブネット**: Webサーバー用
- **プライベートサブネット**: データベース用

#### 適用シーン
- 小規模なアプリケーション
- 開発・テスト環境
- シンプルな構成

---

### 2. マルチAZ設計

#### 構成
- **複数のAZ**: 複数の可用性ゾーンにサブネットを配置
- **パブリックサブネット**: 各AZにパブリックサブネット
- **プライベートサブネット**: 各AZにプライベートサブネット

#### 適用シーン
- 本番環境
- 高可用性が必要なアプリケーション
- 災害復旧が必要なアプリケーション

---

### 3. マルチVPC設計

#### 構成
- **複数のVPC**: 環境ごと（本番、ステージング、開発）にVPCを分離
- **VPCピアリング**: VPC間でピアリング接続
- **Transit Gateway**: 複数のVPCをTransit Gatewayで接続

#### 適用シーン
- 大規模な組織
- 環境ごとに分離が必要
- 複数のチームが異なるVPCを使用

---

## VPCのベストプラクティス

### 1. IPアドレス範囲の設計

#### 推奨事項
- **十分なIPアドレス**: 将来の拡張を考慮して十分なIPアドレス範囲を確保
- **重複の回避**: オンプレミスネットワークや他のVPCと重複しないIPアドレス範囲を選択
- **サブネットの設計**: サブネットごとに適切なIPアドレス範囲を割り当て

---

### 2. サブネットの設計

#### 推奨事項
- **複数のAZ**: 高可用性のために複数のAZにサブネットを配置
- **パブリック/プライベート**: パブリックサブネットとプライベートサブネットを分離
- **用途別**: 用途別にサブネットを分離（Web、アプリケーション、データベース）

---

### 3. セキュリティの設計

#### 推奨事項
- **セキュリティグループ**: インスタンスレベルのセキュリティを設定
- **ネットワークACL**: サブネットレベルのセキュリティを設定
- **最小権限の原則**: 必要最小限のアクセス権限を設定

---

### 4. ルーティングの設計

#### 推奨事項
- **カスタムルートテーブル**: サブネットごとにカスタムルートテーブルを作成
- **ルートの最適化**: 不要なルートを削除
- **ルートの監視**: ルートテーブルの変更を監視

---

## VPCの制限事項

### 1. VPCの制限
- **VPC数**: リージョンごとに最大5つのVPC（デフォルト）
- **サブネット数**: VPCごとに最大200個のサブネット
- **ルートテーブル数**: VPCごとに最大200個のルートテーブル

### 2. 拡張の制限
- **CIDRブロック**: VPCごとに最大5つのCIDRブロック
- **サブネットのCIDR**: サブネットのCIDRブロックはVPCのCIDRブロック内である必要がある

---

## 参考資料

- [AWS VPC公式ドキュメント](https://docs.aws.amazon.com/vpc/)
- [AWS VPCユーザーガイド](https://docs.aws.amazon.com/vpc/latest/userguide/)
- [AWS VPCベストプラクティス](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-best-practices.html)

