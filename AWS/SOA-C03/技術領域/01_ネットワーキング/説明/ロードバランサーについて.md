# AWS ロードバランサーについて

## 概要

AWSのロードバランサーは、複数のターゲット（EC2インスタンス、コンテナ、IPアドレスなど）にトラフィックを分散させるサービスです。ロードバランサーを使用することで、アプリケーションの可用性、スケーラビリティ、パフォーマンスを向上させることができます。

## ロードバランサーの種類

### 1. Application Load Balancer（ALB）

#### 概要
Application Load Balancer（ALB）は、OSIモデルの第7層（アプリケーション層）で動作するロードバランサーです。HTTP/HTTPSトラフィックを処理し、コンテンツベースのルーティングを提供します。

#### 特徴
- **レイヤー7**: アプリケーション層（HTTP/HTTPS）で動作
- **コンテンツベースルーティング**: URLパス、ホストヘッダー、HTTPメソッドなどに基づいてルーティング
- **ターゲットグループ**: 複数のターゲットグループを設定可能
- **SSL/TLS終端**: SSL/TLS証明書の管理と終端
- **WebSocket**: WebSocket接続をサポート
- **HTTP/2**: HTTP/2プロトコルをサポート

#### 適用シーン
- **Webアプリケーション**: Webアプリケーションのロードバランシング
- **マイクロサービス**: マイクロサービスアーキテクチャ
- **コンテナ**: ECS、EKSなどのコンテナワークロード
- **コンテンツベースルーティング**: URLパスやホストヘッダーに基づくルーティング

---

### 2. Network Load Balancer（NLB）

#### 概要
Network Load Balancer（NLB）は、OSIモデルの第4層（トランスポート層）で動作するロードバランサーです。TCP/UDPトラフィックを処理し、高パフォーマンスと低レイテンシを提供します。

#### 特徴
- **レイヤー4**: トランスポート層（TCP/UDP）で動作
- **高パフォーマンス**: 数百万のリクエスト/秒を処理可能
- **低レイテンシ**: 低レイテンシでトラフィックをルーティング
- **静的IP**: 静的IPアドレスを提供
- **ゾーン固定IP**: 各AZに固定IPアドレスを提供
- **ターゲットタイプ**: インスタンス、IPアドレス、Lambda関数

#### 適用シーン
- **高パフォーマンス**: 高パフォーマンスが必要なアプリケーション
- **低レイテンシ**: 低レイテンシが必要なアプリケーション
- **TCP/UDP**: TCP/UDPトラフィックのロードバランシング
- **静的IP**: 静的IPアドレスが必要なアプリケーション

---

### 3. Classic Load Balancer（CLB）

#### 概要
Classic Load Balancer（CLB）は、従来のロードバランサーです。レガシーアプリケーションとの互換性のために提供されていますが、新規の使用は推奨されません。

#### 特徴
- **レガシー**: 従来のロードバランサー
- **レイヤー4/7**: レイヤー4とレイヤー7の両方で動作可能
- **制限**: 機能が制限されている
- **非推奨**: 新規の使用は推奨されない

#### 適用シーン
- **レガシーアプリケーション**: 既存のレガシーアプリケーション
- **移行期間**: ALBやNLBへの移行期間

---

### 4. Gateway Load Balancer（GWLB）

#### 概要
Gateway Load Balancer（GWLB）は、サードパーティの仮想アプライアンス（ファイアウォール、侵入検知システムなど）を透過的に統合するためのロードバランサーです。

#### 特徴
- **仮想アプライアンス**: サードパーティの仮想アプライアンスを統合
- **透過的**: アプリケーションから透過的に動作
- **GENEVEプロトコル**: GENEVEプロトコルを使用
- **スケーラビリティ**: 自動的にスケーリング

#### 適用シーン
- **セキュリティアプライアンス**: ファイアウォール、侵入検知システムなど
- **ネットワークアプライアンス**: ネットワーク仮想アプライアンス
- **コンプライアンス**: コンプライアンス要件で仮想アプライアンスが必要

---

## ロードバランサーの比較

### 1. ロードバランサーの比較表

| 項目 | ALB | NLB | CLB | GWLB |
|------|-----|-----|-----|------|
| **レイヤー** | 7（HTTP/HTTPS） | 4（TCP/UDP） | 4/7 | 3（IP） |
| **パフォーマンス** | 中 | 高 | 低 | 高 |
| **レイテンシ** | 中 | 低 | 中 | 低 |
| **コンテンツベースルーティング** | あり | なし | 制限あり | なし |
| **SSL/TLS終端** | あり | あり | あり | なし |
| **WebSocket** | あり | あり | あり | なし |
| **静的IP** | なし | あり | なし | あり |
| **ターゲットタイプ** | インスタンス、IP、Lambda | インスタンス、IP、Lambda | インスタンスのみ | インスタンス、IP |

---

## ロードバランサーの構成要素

### 1. リスナー（Listener）

#### 概要
リスナーは、ロードバランサーがトラフィックを受信するポートとプロトコルを定義します。

#### 設定項目
- **プロトコル**: HTTP、HTTPS、TCP、TLS、UDP
- **ポート**: リスニングポート（例：80、443）
- **デフォルトアクション**: ターゲットグループへのルーティング

---

### 2. ターゲットグループ（Target Group）

#### 概要
ターゲットグループは、ロードバランサーがトラフィックをルーティングするターゲット（EC2インスタンス、コンテナ、IPアドレスなど）のグループです。

#### ターゲットタイプ
- **インスタンス**: EC2インスタンス
- **IP**: IPアドレス（プライベートIP）
- **Lambda**: Lambda関数（ALBのみ）

#### ヘルスチェック
- **プロトコル**: HTTP、HTTPS、TCP
- **ポート**: ヘルスチェックポート
- **パス**: ヘルスチェックパス（HTTP/HTTPSの場合）
- **間隔**: ヘルスチェック間隔
- **タイムアウト**: ヘルスチェックタイムアウト
- **正常閾値**: 正常とみなす連続成功回数
- **異常閾値**: 異常とみなす連続失敗回数

---

### 3. ルール（Rules）

#### 概要
ルールは、リスナーが受信したトラフィックをどのターゲットグループにルーティングするかを決定します（ALBのみ）。

#### ルールの条件
- **ホストヘッダー**: ホストヘッダーに基づくルーティング
- **パス**: URLパスに基づくルーティング
- **HTTPメソッド**: HTTPメソッドに基づくルーティング
- **クエリ文字列**: クエリ文字列に基づくルーティング
- **ソースIP**: ソースIPアドレスに基づくルーティング

#### ルールのアクション
- **フォワード**: ターゲットグループにフォワード
- **リダイレクト**: HTTPリダイレクト
- **固定レスポンス**: 固定HTTPレスポンスを返す

---

## ロードバランサーのベストプラクティス

### 1. ロードバランサーの選択

#### ALBを選ぶべき場合
- **Webアプリケーション**: Webアプリケーションのロードバランシング
- **コンテンツベースルーティング**: URLパスやホストヘッダーに基づくルーティングが必要
- **マイクロサービス**: マイクロサービスアーキテクチャ
- **コンテナ**: ECS、EKSなどのコンテナワークロード

#### NLBを選ぶべき場合
- **高パフォーマンス**: 高パフォーマンスが必要
- **低レイテンシ**: 低レイテンシが必要
- **TCP/UDP**: TCP/UDPトラフィックのロードバランシング
- **静的IP**: 静的IPアドレスが必要

---

### 2. 高可用性の設計

#### マルチAZ配置
- **複数のAZ**: 複数の可用性ゾーンにロードバランサーを配置
- **自動フェイルオーバー**: 1つのAZで障害が発生しても、他のAZで継続動作
- **ヘルスチェック**: ターゲットのヘルスチェックを設定

---

### 3. セキュリティの設定

#### SSL/TLS終端
- **証明書の管理**: ACM（AWS Certificate Manager）を使用して証明書を管理
- **SSL/TLS終端**: ロードバランサーでSSL/TLSを終端
- **セキュリティグループ**: セキュリティグループでトラフィックを制御

---

### 4. パフォーマンスの最適化

#### 接続の最適化
- **接続の再利用**: 接続の再利用を有効化
- **アイドルタイムアウト**: アイドルタイムアウトを適切に設定
- **HTTP/2**: HTTP/2プロトコルを有効化（ALB）

---

## ロードバランサーのコスト

### 1. 料金体系

#### ALB
- **時間単位の料金**: 時間単位の料金
- **LCU（Load Balancer Capacity Units）**: 処理能力に基づく料金
- **データ転送料金**: データ転送料金

#### NLB
- **時間単位の料金**: 時間単位の料金
- **NLCU（Network Load Balancer Capacity Units）**: 処理能力に基づく料金
- **データ転送料金**: データ転送料金

---

## 参考資料

- [AWS Application Load Balancer公式ドキュメント](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/)
- [AWS Network Load Balancer公式ドキュメント](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/)
- [AWS Gateway Load Balancer公式ドキュメント](https://docs.aws.amazon.com/elasticloadbalancing/latest/gateway/)

